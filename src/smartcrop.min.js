!function(){"use strict";var d={};function g(t,e,i){for(var r=i.data,a=i.width,n=~~t.x,o=~~(t.x+t.width),h=~~t.y,s=~~(t.y+t.height),d=255*t.weight,u=h;u<s;u++)for(var g=n;g<o;g++){r[4*(u*a+g)+3]+=d}}function c(t,e,i){for(var r={detail:0,saturation:0,skin:0,boost:0,total:0},a=e.data,n=t.scoreDownSample,o=1/n,h=e.height*n,s=e.width*n,d=e.width,u=0;u<h;u+=n)for(var g=0;g<s;g+=n){var c=4*(~~(u*o)*d+~~(g*o)),f=p(t,i,g,u),l=a[c+1]/255;r.skin+=a[c]/255*(l+t.skinBias)*f,r.detail+=l*f,r.saturation+=a[c+2]/255*(l+t.saturationBias)*f,r.boost+=a[c+3]/255*f}return r.total=(r.detail*t.detailWeight+r.skin*t.skinWeight+r.saturation*t.saturationWeight+r.boost*t.boostWeight)/(i.width*i.height),r}function p(t,e,i,r){if(e.x>i||i>=e.x+e.width||e.y>r||r>=e.y+e.height)return t.outsideImportance;i=(i-e.x)/e.width,r=(r-e.y)/e.height;var a=2*w(.5-i),n=2*w(.5-r),o=Math.max(a-1+t.edgeRadius,0),h=Math.max(n-1+t.edgeRadius,0),s=(o*o+h*h)*t.edgeWeight,d=1.41-k(a*a+n*n);return t.ruleOfThirds&&(d+=1.2*Math.max(0,d+s+.5)*(v(a)+v(n))),d+s}function M(t,e,i){this.width=t,this.height=e,this.data=i?new Uint8ClampedArray(i):new Uint8ClampedArray(t*e*4)}function f(t,e){for(var i=t.data,r=t.width,a=Math.floor(t.width/e),n=Math.floor(t.height/e),o=new M(a,n),h=o.data,s=1/(e*e),d=0;d<n;d++)for(var u=0;u<a;u++){for(var g=4*(d*a+u),c=0,f=0,l=0,p=0,w=0,m=0,v=0;v<e;v++)for(var x=0;x<e;x++){var y=4*((d*e+v)*r+(u*e+x));c+=i[y],f+=i[y+1],l+=i[y+2],p+=i[y+3],w=Math.max(w,i[y]),m=Math.max(m,i[y+1])}h[g]=c*s*.5+.5*w,h[g+1]=f*s*.7+.3*m,h[g+2]=l*s,h[g+3]=p*s}return o}function e(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i}function a(n){return{open:function(t){var e=t.naturalWidth||t.width,i=t.naturalHeight||t.height,r=n(e,i),a=r.getContext("2d");return!t.naturalWidth||t.naturalWidth==t.width&&t.naturalHeight==t.height?(r.width=t.width,r.height=t.height):(r.width=t.naturalWidth,r.height=t.naturalHeight),a.drawImage(t,0,0),d.Promise.resolve(r)},resample:function(t,i,r){return Promise.resolve(t).then(function(t){var e=n(~~i,~~r);return e.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e.width,e.height),d.Promise.resolve(e)})},getData:function(t){return Promise.resolve(t).then(function(t){var e=t.getContext("2d").getImageData(0,0,t.width,t.height);return new M(t.width,t.height,e.data)})}}}d.Promise="undefined"!=typeof Promise?Promise:function(){throw new Error("No native promises and smartcrop.Promise not set.")},d.DEFAULTS={width:0,height:0,aspect:0,cropWidth:0,cropHeight:0,detailWeight:.2,skinColor:[.78,.57,.44],skinBias:.01,skinBrightnessMin:.2,skinBrightnessMax:1,skinThreshold:.8,skinWeight:1.8,saturationBrightnessMin:.05,saturationBrightnessMax:.9,saturationThreshold:.4,saturationBias:.2,saturationWeight:.1,scoreDownSample:8,step:8,scaleStep:.1,minScale:1,maxScale:1,edgeRadius:.4,edgeWeight:-20,outsideImportance:-.5,boostWeight:100,ruleOfThirds:!0,prescale:!0,imageOperations:null,canvasFactory:e,debug:!1},d.crop=function(t,e,o){var h=m({},d.DEFAULTS,e);h.aspect&&(h.width=h.aspect,h.height=1),null===h.imageOperations&&(h.imageOperations=a(h.canvasFactory));var i=h.imageOperations,r=1,s=1;return i.open(t,h.input).then(function(t){return h.width&&h.height&&(r=l(t.width/h.width,t.height/h.height),h.cropWidth=~~(h.width*r),h.cropHeight=~~(h.height*r),h.minScale=l(h.maxScale,u(1/r,h.minScale)),!1!==h.prescale&&((s=l(u(256/t.width,256/t.height),1))<1?(t=i.resample(t,t.width*s,t.height*s),h.cropWidth=~~(h.cropWidth*s),h.cropHeight=~~(h.cropHeight*s),h.boost&&(h.boost=h.boost.map(function(t){return{x:~~(t.x*s),y:~~(t.y*s),width:~~(t.width*s),height:~~(t.height*s),weight:t.weight}}))):s=1)),t}).then(function(t){return i.getData(t).then(function(t){for(var e=function(t,e){var i={},r=new M(e.width,e.height);(function(t,e){for(var i=t.data,r=e.data,a=t.width,n=t.height,o=0;o<n;o++)for(var h=0;h<a;h++){var s,d=4*(o*a+h);s=0===h||a-1<=h||0===o||n-1<=o?x(i,d):4*x(i,d)-x(i,d-4*a)-x(i,d-4)-x(i,d+4)-x(i,d+4*a),r[d+1]=s}})(e,r),function(t,e,i){for(var r=e.data,a=i.data,n=e.width,o=e.height,h=0;h<o;h++)for(var s=0;s<n;s++){var d=4*(h*n+s),u=W(r[d],r[d+1],r[d+2])/255,g=(l=t,p=r[d],w=r[d+1],m=r[d+2],void 0,v=k(p*p+w*w+m*m),x=p/v-l.skinColor[0],y=w/v-l.skinColor[1],M=m/v-l.skinColor[2],1-k(x*x+y*y+M*M)),c=g>t.skinThreshold,f=u>=t.skinBrightnessMin&&u<=t.skinBrightnessMax;a[d]=c&&f?(g-t.skinThreshold)*(255/(1-t.skinThreshold)):0}var l,p,w,m,v,x,y,M}(t,e,r),function(t,e,i){for(var r=e.data,a=i.data,n=e.width,o=e.height,h=0;h<o;h++)for(var s=0;s<n;s++){var d=4*(h*n+s),u=W(r[d],r[d+1],r[d+2])/255,g=y(r[d],r[d+1],r[d+2]),c=g>t.saturationThreshold,f=u>=t.saturationBrightnessMin&&u<=t.saturationBrightnessMax;a[d+2]=f&&c?(g-t.saturationThreshold)*(255/(1-t.saturationThreshold)):0}}(t,e,r),function(t,e){if(!t.boost)return;for(var i=e.data,r=0;r<e.width;r+=4)i[r+3]=0;for(r=0;r<t.boost.length;r++)g(t.boost[r],t,e)}(t,r);for(var a=f(r,t.scoreDownSample),n=-1/0,o=null,h=function(t,e,i){for(var r=[],a=l(e,i),n=t.cropWidth||a,o=t.cropHeight||a,h=t.maxScale;h>=t.minScale;h-=t.scaleStep)for(var s=0;s+o*h<=i;s+=t.step)for(var d=0;d+n*h<=e;d+=t.step)r.push({x:d,y:s,width:n*h,height:o*h});return r}(t,e.width,e.height),s=0,d=h.length;s<d;s++){var u=h[s];u.score=c(t,a,u),u.score.total>n&&(n=(o=u).score.total)}i.topCrop=o,t.debug&&o&&(i.crops=h,i.debugOutput=r,i.debugOptions=t,i.debugTopCrop=m({},i.topCrop));return i}(h,t),i=e.crops||[e.topCrop],r=0,a=i.length;r<a;r++){var n=i[r];n.x=~~(n.x/s),n.y=~~(n.y/s),n.width=~~(n.width/s),n.height=~~(n.height/s)}return o&&o(e),e})})},d.isAvailable=function(t){if(!d.Promise)return!1;if((t?t.canvasFactory:e)===e&&!document.createElement("canvas").getContext("2d"))return!1;return!0},d.importance=p,d.ImgData=M,d._downSample=f,d._canvasImageOperations=a;var l=Math.min,u=Math.max,w=Math.abs,k=Math.sqrt;function m(t){for(var e=1,i=arguments.length;e<i;e++){var r=arguments[e];if(r)for(var a in r)t[a]=r[a]}return t}function v(t){return t=16*((t-1/3+1)%2*.5-.5),Math.max(1-t*t,0)}function W(t,e,i){return.5126*i+.7152*e+.0722*t}function x(t,e){return W(t[e],t[e+1],t[e+2])}function y(t,e,i){var r=u(t/255,e/255,i/255),a=l(t/255,e/255,i/255);if(r===a)return 0;var n=r-a;return.5<(r+a)/2?n/(2-r-a):n/(r+a)}"undefined"!=typeof define&&define.amd&&define(function(){return d}),"undefined"!=typeof exports?exports.smartcrop=d:"undefined"!=typeof navigator&&(window.SmartCrop=window.smartcrop=d),"undefined"!=typeof module&&(module.exports=d)}();